<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genesys Client App</title>
</head>
<body>
    <h1>Customer Information</h1>
    <label id="conversationIdLabel">Conversation ID: <span id="conversationId"></span></label>
    <pre id="output"></pre>

    <script>
    const CLIENT_ID = '69693332-4588-40cd-9fc7-6f53b0f925ad';

    // Genesys Cloud environment https://login.sae1.pure.cloud/oauth/authorize
    const ENVIRONMENT = 'sae1.pure.cloud';

function getParameterByName(name) {
    name = name.replace(/[\\[]/, "\\[").replace(/[\]]/, "\\]");
    var regex = new RegExp("[\\#&]" + name + "=([^&#]*)"),
      results = regex.exec(location.hash);
    return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
}

function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

var conversationId = getQueryParam('conversationId')

if(window.location.hash) {
    console.log(location.hash);
    var token = getParameterByName('access_token');

    getConversationDetails(conversationId, token)

    location.hash=''

} else {

    var queryStringData = {
        response_type : "token",
        client_id : CLIENT_ID,
        redirect_uri : `https://jffgomes.github.io/teste/?conversationId=${conversationId}`
    }

    window.location.replace(`https://login.${ENVIRONMENT}/oauth/authorize?` + jQuery.param(queryStringData));
}

async function getConversationDetails(conversationId, accessToken) {
            const url = `https://api.sae1.pure.cloud/api/v2/analytics/conversations/${conversationId}/details`;
            const headers = {
                'Authorization': `Bearer ${accessToken}`,
                'Accept': 'application/json'
            };

            const conversationIdLabel = document.getElementById('conversationId');
            const output = document.getElementById('output');

            if (!conversationId) {
                output.textContent = 'Error: No conversation ID provided in the URL';
                return;
            } else {

                try {
                    try {
                        const response = await fetch(url, {
                            method: 'GET',
                            headers,
                        });
                        const result = await response.json();

                        output.textContent = JSON.stringify(result, null, 2);
                    }
                    catch (error) {
                        output.textContent = `Error: ${error.message}`;
                    }

                    // return result;
                } catch (error) {
                    console.error('Error fetching conversation details:', error);
                    throw error;
                }
            }
        }
    

    </script>
</body>
</html>